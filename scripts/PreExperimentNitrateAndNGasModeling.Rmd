---
title: "Pre-experiment nitrate and nitrogen gas modeling"
author: "Libby Mohr"
date: "8-9-2021"
output: html_document
---

## Overview
We will be conducting a set of $^{15}$N-NO$_3$ release in 15 stream analogue mesocosms (SAMS) in order to characterize rates of assimilatory nitrate uptake and denitrification in each SAM. The purpose of this analysis is to determine a suitable set of sampling times following the isotopic release. To accomplish this objective, I've used the Linx II dataset to parameterize statistical models for two, first-order rate constants characterizing rates of total nitrate uptake and denitrification. I then used this relationship to produce time series of $^{15}$NO$_3$ concentrations and $^{15}$N$_{gas}$ concentrations in a SAM, while propagating the residual error and parameter uncertainty to produce prediction intervals.

## Import and Wrangle Linx II data
I begin by reading in the Linx II data. Because the first-order rate constants for total nitrate uptake and denitrification are given with dimensions of [L$^{-1}$], it is necessary to multiply by stream velocity to get a time-based rate constant (which is desirable for our circular flumes). Then, because the change in solute concentration for a given streambed demand depends on water depth, I re-scaled the first-order rate constants by multiplying by the depth of the stream (to get an uptake velocity), and then by dividing by the depth of the SAM raceway. Finally, I calculated the natural logarithms of both first-order rate constants and nitrate concentrations, since previous work (e.g. Mulholland et al., 2008) has demonstrated a power law relationship between uptake velocity and nitrate concentrations.
```{r}
library(readxl)
library(tidyverse)
library(here)

linx <- read_xlsx(path = here("data", "LINXII.xlsx"), 
                  sheet = "Data",
                  col_types = c(rep("text", times = 3), 
                                rep("numeric", times = 11)),
                  na = "NA")

# Note: rate constants were originally given in units of m^-1, and velocities in m/min, so final 
# rate constant units as calculated here are in min^-1

racewayDepth <- 0.15 # meters

linx <- linx %>% 
  filter(!NO3 == 0) %>%
  mutate(ktot_norm = ktot * Velocity * Depth/racewayDepth,
         kden_norm = kden * Velocity * Depth/racewayDepth) %>% 
  mutate(ku_norm = ktot_norm - kden_norm) %>%
  mutate(ku_norm_log = log(ku_norm),
         kden_norm_log = log(kden_norm),
         ktot_norm_log = log(ktot_norm),
         NO3_log = log(NO3), 
         ER_log = log(ER_grams_m2_day)) %>%
  filter(!is.na(ER_log))
```

## Estimate Parameters
Here, I estimate parameters for two simple linear models: 
$$ log(k_{tot}) = \beta_0 + \beta_1log([NO_3^{-1}]) +\epsilon $$
$$ log(k_{den}) = \beta_0 + \beta_1log([NO_3^{-1}]) + \beta_2log(ER) +\epsilon $$
where $\epsilon \sim Normal(0, \sigma^2)$

I use Just Another Gibbs Sampler (JAGS) to sample the posterior distributions of the linear regression coefficients and the precisions of both random error terms.
```{r}
library(rjags)
library(coda)
library(eivtools)

# Make data into a list that can be passed to JAGS
data <- list(x = linx$NO3_log, kTot = linx$ktot_norm_log, kDen = linx$kden_norm_log,ER = linx$ER_log, n = nrow(linx))

# Specify moments for priors
data$b0 <- c(0,0)  # means for multivariate-normal linear regression coefficient prior
data$b0Den <- c(0,0,0)  # means for multivariate-normal linear regression coefficient prior
data$Vb <- solve(diag(1000,2)) # precisions for multivariate-normal linear regression coefficient prior
data$VbDen <- solve(diag(1000,3)) # precisions for multivariate-normal linear regression coefficient prior
data$s1 <- 0.1  # shape parameter for gamma-distributed error prior 
data$s2 <- 0.1  # scale parameter for gamma-distributed error prior

# Define model code
multivariate_regression <- "
model{

  betakTot ~ dmnorm(b0,Vb)      ## multivariate Normal prior on vector of regression params
  betakDen ~ dmnorm(b0Den,VbDen)      ## multivariate Normal prior on vector of regression params
  preckTot ~ dgamma(s1,s2)   ## prior precision
  preckDen ~ dgamma(s1,s2)   ## prior precision

  for(i in 1:n){
      mukTot[i] <- betakTot[1] + betakTot[2]*x[i]   
      kTot[i]  ~ dnorm(mukTot[i], preckTot)  
      mukDen[i] <- betakDen[1] + betakDen[2]*x[i] + betakDen[2]* ER[i]  
      kDen[i]  ~ dnorm(mukDen[i], preckDen)  
  }
}"

# Specify number of chains, initial conditions
nChains = 3
inits <- list()
for(i in 1:nChains){
 inits[[i]] <- list(betakTot = rnorm(2,0,5), betakDen = rnorm(3,0,5), preckTot = runif(1,1/100,1/20), preckDen = runif(1,1/100,1/20))
}

# Create JAGS model object
jagsModel <- jags.model(file = textConnection(multivariate_regression),
                        data = data,
                        inits = inits,
                        n.chains = nChains)
# Sample posterior distribution 
var.out <- coda.samples (model = jagsModel,
                         variable.names = c("betakTot", "betakDen", "preckTot", "preckDen"),
                         n.iter = 5000)

# Evaluate Model
plot(var.out)
gelman.diag(var.out)
GBR <- gelman.plot(var.out)

# Remove burn-in
burnin = 1000                               
jags.burn <- window(var.out, start=burnin)  
plot(jags.burn)   

# Convert output to matrix
out <- as.matrix(jags.burn)
```

## Simulate Nitrate and Nitrogen Gas Dynamics
Here I use a Monte Carlo approach to propagating uncertainty by randomly sampling rows from the MCMC output, calculating first-order rate constants based on the parameters in each row, and simulating $^{15}$N-NO$_3$ and $^{15}$N-NO$_3$ concentrations for 24 hours following an isotopic release according to a first-order kinetic model with gas exchange. I've run the Monte Carlo simulation for three nitrate concentrations, three ecosystem respiration rates, and three gas exchange constants for comparison purposes. 
```{r}
library(isoToolsR)
source(here("functions", "NUptakeModels.R"))
source(here("functions", "predictionIntervals.R"))
RstN <- 0.003678 # isotope ratio of nitrogen standard
AFadd <- 0.984 # atom fraction of N15-nitrate tracer

# Specify number of realizations
n <- 5000

# Define indices to sample MCMC output
indices <- sample.int(nrow(out), n, replace = TRUE)

# Specify simulation time in minutes
times <- seq(0, 24*60, length.out = 500)

# Generate data frame of parameter combinations

percentTracer <- calcPercentTracer(12000, RstN, AFadd)
params <- tibble(
  NO3Pre = c(100, 150, 200), # Nitrate concentration in SAM before isotope release
  k2 = c(0.005,0.015,0.025), # Gas exchange constants (min^-1),
  ER = c(0.7, 4.0, 8.6) # Ecosystem respiration (g/(m^2*day))
) %>%
  expand(NO3Pre, k2, ER) %>%
  mutate(NO30 = (1+percentTracer) * NO3Pre, # Initial nitrate concentration 
         N15NO30 = AFadd * percentTracer * NO3Pre + RToAtomFrac(RstN)*NO3Pre) # Initial N15 nitrate concentration 

# For each combination of parameters, generate ensemble of predictions for delta 15N-NGas vs. time
ensembles <- pmap(params, 
                  predictN15,
                  B0Tot = out[indices,"betakTot[1]"], 
                  B1Tot = out[indices,"betakTot[2]"], 
                  precTot = out[indices,"preckTot"], 
                  B0Den = out[indices, "betakDen[1]"],
                  B1Den = out[indices,"betakDen[2]"], 
                  B2Den = out[indices,"betakDen[3]"], 
                  precDen = out[indices,"preckDen"], 
                  times = times)

# Calculate median, 2.5% and 97.5% quantiles for each time
NO3PIs <- map_dfr(ensembles, getPI, times = times, varName = "Nitrate")
N15NO3PIs <- map_dfr(ensembles, getPI, times = times, varName = "N15Nitrate")
NGasPIs <- map_dfr(ensembles, getPI, times = times, varName = "N15Gas")

# Plot prediction intervals with median
library(ggtext)
k2 <- c(0.005,0.015,0.025)
k2Labs <- paste("k<sub>2</sub> = ", k2, "min<sup>-1</sup>")
names(k2Labs) <- k2
NO3Pre <- c(100, 150, 200)
NO3PreLabs <- paste("[NO<sub>3</sub>]<sub>bg</sub> = ", NO3Pre, "&mu;g L<sup>-1</sup>")
names(NO3PreLabs) <- NO3Pre

# Convert concentrations from ug N/L to uM nitrate
NO3PIs <- NO3PIs %>% 
  mutate(Median = Median/14,
         Lower = Lower/14,
         Upper = Upper/14)

N15NO3PIs <- N15NO3PIs %>% 
  mutate(Median = Median/15,
         Lower = Lower/15,
         Upper = Upper/15)

# Compare nitrate concentration vs. time for three initial nitrate concentrations
plotPI(NO3PIs) + 
  facet_wrap(vars(NO3Pre), nrow = 1, labeller = labeller(NO3Pre = NO3PreLabs)) + 
  ylab("[NO3] (uM)") +
  theme(strip.text = element_markdown(), plot.title = element_markdown()) +
  geom_hline(yintercept = 4, color = "red")

# Compare N15-nitrate concentration vs. time for three initial nitrate concentrations
plotPI(N15NO3PIs) + 
  facet_wrap(vars(NO3Pre), nrow = 1, labeller = labeller(NO3Pre = NO3PreLabs)) + 
  ylab("[15N-NO3] (uM)")  + 
  ggtitle("(&delta;<sup>15</sup>N-NO<sub>3</sub>)<sub>init</sub> = 12,000&permil; , [NO<sub>3</sub>]<sub>bg</sub> = 200 &mu;g L<sup>-1</sup>") +
  theme(strip.text = element_markdown(), plot.title = element_markdown()) 

# Compare N5-gas concentrations among background nitrate concentrations
ggplot(NGasPIs %>% filter(k2 == 0.015, ER == 4), aes(x = times, y = Median)) + 
  geom_point()+
  facet_wrap(vars(NO3Pre), labeller = labeller(NO3Pre = NO3PreLabs)) +
  ylab("[15N-Ngas]") +
  theme(strip.text = element_markdown(), strip.text.x = element_markdown(),strip.text.y = element_markdown(),plot.title = element_markdown()) 

# Compare N5-gas concentrations among among gas exchange constants
ggplot(NGasPIs %>% filter(NO3Pre == 150, ER == 4), aes(x = times, y = Median)) + 
  geom_point()+
  facet_wrap(vars(k2), labeller = labeller(k2 = k2Labs)) +
  ylab("[15N-Ngas]") +
  theme(strip.text = element_markdown(), strip.text.x = element_markdown(),strip.text.y = element_markdown(),plot.title = element_markdown()) 

# Compare N5-gas concentrations ecosystem respiration rates
ggplot(NGasPIs %>% filter(NO3Pre == 150, k2 == 0.015), aes(x = times, y = Median)) + 
  geom_point() + 
  facet_wrap(vars(ER))

```

## Summary of findings: 
- There's a ton of uncertainty in the rate-constants for total nitrate uptake and denitrification. This uncertainty could potentially be reduced by incorporating GPP and ER as covariates, respectively. 
- The level of isotopic enrichment shouldn't matter too much assuming we will be above the detection limit at UC Davis. 
- The timing of nitrate sampling depends only on the rate of total nitrate uptake and not on background nitrate concentration, isotopic enrichment level, or gas exchange.
- The timing of denitrification sampling depends both on the rate denitrification and on the rate of gas exchange.

## Worthwhile next steps: 
- Constrain gross nitrate uptake rates by estimating net nitrate uptake with measurements of mesocosm inflows and outlows.
- Constrain gross nitrate uptake rates and denitrification rates by adding additional covariates like GPP and respiration.
- Estimate gas exchange.


